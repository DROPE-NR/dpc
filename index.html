<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Despesas Mensais Casa 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #111;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .btn {
      background-color: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 4px;
    }
    .btn:hover {
      background-color: #059669;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      text-align: center;
      vertical-align: top;
    }
    thead th {
      background-color: #3b82f6;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td input[type="number"] {
      width: 70px;
      padding: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 4px;
    }
    tbody td select {
      padding: 4px;
      width: 80px;
      border-radius: 4px;
      font-size: 12px;
    }
    tfoot td {
      font-weight: bold;
      background-color: #f9fafb;
    }
    .paid {
      background-color: #d1fae5 !important;
    }
    .unpaid {
      background-color: #fee2e2 !important;
    }
    .remove-btn, .archive-btn, .restore-btn {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
    }
    .archive-btn {
      background-color: #6b7280;
    }
    .restore-btn {
      background-color: #3b82f6;
    }
    .remove-btn:hover {
      background-color: #dc2626;
    }
    .archive-btn:hover {
      background-color: #4b5563;
    }
    .restore-btn:hover {
      background-color: #2563eb;
    }
    canvas {
      max-width: 900px;
      margin: 40px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Despesas Mensais - Casa 2025</h1>
  <div class="controls">
    <button class="btn" onclick="addRow()">Adicionar Despesa</button>
    <button class="btn" onclick="toggleArquivadas()" id="toggle-arquivadas">Mostrar Arquivadas</button>
  </div>
  <table id="despesas">
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
        <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
        <th>Total Item</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="despesas-body"></tbody>
    <tfoot>
      <tr>
        <td>Total</td>
        <td id="total-jan"></td><td id="total-fev"></td><td id="total-mar"></td><td id="total-abr"></td>
        <td id="total-mai"></td><td id="total-jun"></td><td id="total-jul"></td><td id="total-ago"></td>
        <td id="total-set"></td><td id="total-out"></td><td id="total-nov"></td><td id="total-dez"></td>
        <td id="total-anual" colspan="2" style="text-align: center;"></td>
      </tr>
    </tfoot>
  </table>

  <canvas id="graficoGastos"></canvas>

<script>
  const endpointGoogle = "https://script.google.com/macros/s/AKfycby_XFDCGaov3DYG0RxvFz6SySYKHzih9MlaDjfkeQMl7VpdPis7uRAvJG9oTlXB9WNJ/exec";
  const meses = ["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"];
  let chart = null;

  function enviarParaGoogleSheets(dados) {
    fetch(endpointGoogle, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        aba: "Despesas_Data",
        dados: dados
      })
    })
    .then(response => response.json())
    .then(res => console.log("Google Sheets:", res))
    .catch(err => console.error("Erro ao enviar para Sheets:", err));
  }

  function salvarDados() {
    const rows = [...document.querySelectorAll("#despesas-body tr")];
    const dados = rows.map(row => {
      const descricao = row.querySelector("td[contenteditable]").innerText;
      const celulas = [...row.querySelectorAll("td")].slice(1, 13);
      const valores = celulas.map(td => ({
        valor: parseFloat(td.querySelector("input")?.value) || 0,
        status: td.querySelector("select")?.value
      }));
      const arquivado = row.getAttribute('data-arquivado') === 'true';
      return { descricao, valores, arquivado };
    });
    localStorage.setItem("despesas2025", JSON.stringify(dados));
    enviarParaGoogleSheets(dados);
  }

  function carregarDados() {
    const dados = JSON.parse(localStorage.getItem("despesas2025")) || [];
    dados.forEach(despesa => addDespesaCarregada(despesa));
    calcularTotais();
  }

  function criarCelula(mesIndex, data = { valor: 0, status: "" }) {
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = "number";
    input.value = data.valor;
    input.oninput = () => { calcularTotais(); salvarDados(); };

    const select = document.createElement("select");
    ["", "pago", "nao-pago"].forEach(s => {
      const option = document.createElement("option");
      option.value = s;
      option.text = s === "" ? "Status" : s === "pago" ? "Pago" : "Não Pago";
      if (data.status === s) option.selected = true;
      select.appendChild(option);
    });
    select.onchange = () => { updateStatus(select); calcularTotais(); salvarDados(); };

    td.appendChild(input);
    td.appendChild(document.createElement("br"));
    td.appendChild(select);
    updateStatus(select);
    return td;
  }

  function addDespesaCarregada(d) {
    const tbody = document.getElementById("despesas-body");
    const row = document.createElement("tr");
    if (d.arquivado) {
      row.setAttribute("data-arquivado", "true");
      row.style.display = "none";
    }
    const descricao = document.createElement("td");
    descricao.contentEditable = true;
    descricao.innerText = d.descricao;
    descricao.oninput = salvarDados;
    row.appendChild(descricao);
    for (let i = 0; i < 12; i++) row.appendChild(criarCelula(i, d.valores[i]));
    const totalItem = document.createElement("td"); totalItem.classList.add("total-item"); row.appendChild(totalItem);
    const acoes = document.createElement("td");
    acoes.innerHTML = `
      <button class="archive-btn" onclick="arquivarRow(this)">Arquivar</button>
      <button class="restore-btn" onclick="restaurarRow(this)" style="display:${d.arquivado ? 'inline-block' : 'none'}">Restaurar</button>
      <button class="remove-btn" onclick="removeRow(this)">Remover</button>
    `;
    row.appendChild(acoes);
    tbody.appendChild(row);
  }

  function addRow() {
    addDespesaCarregada({ descricao: "Nova Despesa", valores: Array(12).fill({ valor: 0, status: "" }), arquivado: false });
    calcularTotais();
    salvarDados();
  }

  function removeRow(button) {
    button.closest("tr").remove();
    calcularTotais();
    salvarDados();
  }

  function arquivarRow(button) {
    const row = button.closest("tr");
    row.setAttribute("data-arquivado", "true");
    row.style.display = "none";
    button.style.display = "none";
    row.querySelector(".restore-btn").style.display = "inline-block";
    calcularTotais();
    salvarDados();
  }

  function restaurarRow(button) {
    const row = button.closest("tr");
    row.removeAttribute("data-arquivado");
    row.style.display = "";
    row.querySelector(".archive-btn").style.display = "inline-block";
    button.style.display = "none";
    calcularTotais();
    salvarDados();
  }

  function toggleArquivadas() {
    const btn = document.getElementById("toggle-arquivadas");
    const mostrar = btn.textContent.includes("Mostrar");
    document.querySelectorAll("#despesas-body tr[data-arquivado='true']").forEach(row => {
      row.style.display = mostrar ? "" : "none";
    });
    btn.textContent = mostrar ? "Ocultar Arquivadas" : "Mostrar Arquivadas";
    calcularTotais();
  }

  function updateStatus(select) {
    const td = select.parentElement;
    td.classList.remove("paid", "unpaid");
    if (select.value === "pago") td.classList.add("paid");
    if (select.value === "nao-pago") td.classList.add("unpaid");
  }

  function calcularTotais() {
    const totaisMes = Array(12).fill(0);
    const labelsGrafico = [], valoresGrafico = [];
    const rows = document.querySelectorAll("#despesas-body tr");

    rows.forEach((tr) => {
      let totalLinha = 0;
      const descricao = tr.querySelector("td[contenteditable]").innerText;

      tr.querySelectorAll("td").forEach((td, i) => {
        if (i >= 1 && i <= 12) {
          const valor = parseFloat(td.querySelector("input")?.value) || 0;
          const status = td.querySelector("select")?.value;
          if (status === "pago") {
            totaisMes[i - 1] += valor;
            if (tr.style.display !== "none") totalLinha += valor;
          }
        }
      });

      if (tr.style.display !== "none") {
        tr.querySelector(".total-item").innerText = `R$ ${totalLinha.toFixed(2)}`;
        labelsGrafico.push(descricao);
        valoresGrafico.push(totalLinha);
      }
    });

    meses.forEach((mes, i) => {
      document.getElementById(`total-${mes}`).innerText = `R$ ${totaisMes[i].toFixed(2)}`;
    });

    const totalAnual = totaisMes.reduce((acc, val) => acc + val, 0);
    document.getElementById("total-anual").innerText = `R$ ${totalAnual.toFixed(2)}`;
    desenharGrafico(labelsGrafico, valoresGrafico);
  }

  function desenharGrafico(labels, valores) {
    const ctx = document.getElementById("graficoGastos").getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: labels,
        datasets: [{
          label: "Gastos por item (visíveis e pagos)",
          data: valores,
          backgroundColor: [
            "#3b82f6", "#10b981", "#f59e0b", "#ef4444", "#6366f1", "#ec4899",
            "#14b8a6", "#8b5cf6", "#f97316", "#22d3ee", "#84cc16", "#f43f5e"
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  document.addEventListener("DOMContentLoaded", carregarDados);
</script>
</body>
</html>
